<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gestión</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <!-- Pantalla de Login -->
    <div id="loginSection" class="section">
      <h1>Sistema de Gestión</h1>
      <h2>Iniciar Sesión</h2>
      <div class="form-group">
        <label for="loginUsername">Usuario</label>
        <input type="text" id="loginUsername" placeholder="Nombre de usuario" required>
      </div>
      <div class="form-group">
        <label for="loginPassword">Contraseña</label>
        <input type="password" id="loginPassword" placeholder="Contraseña" required>
      </div>
      <button onclick="login()">Iniciar Sesión</button>
      <p class="error" id="loginError"></p>
      <a class="link" onclick="showForgotPassword()">¿Olvidaste tu contraseña?</a>
    </div>

    <!-- Modal Olvidé mi contraseña -->
    <div id="forgotPasswordSection" class="section" style="display: none;">
      <h2>Recuperar Contraseña</h2>
      <div class="form-group">
        <label for="forgotEmail">Correo Electrónico</label>
        <input type="email" id="forgotEmail" placeholder="correo@ejemplo.com" required>
      </div>
      <button onclick="forgotPassword()">Enviar</button>
      <button class="back" onclick="hideForgotPassword()">Volver</button>
      <p class="error" id="forgotPasswordError"></p>
      <p class="success" id="forgotPasswordSuccess"></p>
    </div>

    <!-- Menú Principal -->
  <div id="mainMenu" class="section" style="display: none;">
    <h1>Menú Principal</h1>
    <p>Bienvenido, <span id="menuUser"></span> (<span id="menuDepartment"></span>)</p>
    <button class="logout" onclick="logout()">Cerrar Sesión</button>
    <div class="menu-buttons">
      <button onclick="window.location.href='tickets.html'">Tickets</button>
      <button onclick="window.location.href='permiso.html'">Permisos</button>
      <button id="btnInventario" style="display:none;" onclick="window.location.href='inventario.html'">Inventario</button>
      <button id="btnAdminUsers" style="display:none;" onclick="showAdminSection()">Gestión de Usuarios</button>
      <button id="btnAdminTickets" style="display:none;" onclick="showAdminTickets()">Todos los Tickets</button>
      <button id="btnAdminPermisos" style="display:none;" onclick="showAdminPermisos()">Todos los Permisos</button>
      <button id="btnRHChecador" style="display:none;" onclick="window.location.href='dashboard_checador.html'">Ver Dashboard de checadas</button>
    </div>
  </div>

  <div id="formSection" class="section" style="display: none;">
    <div class="form-section">
      <button class="logout" onclick="window.location.href='index.html'" style="margin-bottom: 1rem;">Volver al menú principal</button>
      <h2>Crear Usuario</h2>
      <div class="form-group">
        <label for="registerUsername">Usuario *</label>
        <input type="text" id="registerUsername" placeholder="Nombre de usuario" required>
      </div>
      <div class="form-group">
        <label for="registerPassword">Contraseña *</label>
        <input type="password" id="registerPassword" placeholder="Contraseña" required>
      </div>
      <div class="form-group">
        <label for="registerEmail">Correo Electrónico *</label>
        <input type="email" id="registerEmail" placeholder="correo@ejemplo.com" required>
      </div>
      <div class="form-group">
        <label for="registerDepartment">Departamento *</label>
        <select id="registerDepartment" required>
          <option value="Mantenimiento">Mantenimiento</option>
          <option value="Sistemas">Sistemas</option>
          <option value="Recursos Humanos">Recursos Humanos</option>
        </select>
      </div>
      <div class="form-group">
        <label for="registerRole">Rol *</label>
        <select id="registerRole" required>
          <option value="user">Usuario</option>
          <option value="supervisor">Supervisor</option>
          <option value="rh">RH</option>
          <option value="admin">Administrador</option>
        </select>
      </div>
      <div class="form-group">
        <label for="registerJefe">Jefe inmediato</label>
        <select id="registerJefe">
          <option value="">Sin jefe</option>
          <!-- Opciones llenadas dinámicamente -->
        </select>
      </div>
      <div class="form-group">
        <label for="registerVacaciones">Días de vacaciones</label>
        <input type="number" id="registerVacaciones" min="0" value="0">
      </div>
      <button onclick="register()">Crear Usuario</button>
      <p class="error" id="registerError"></p>
    </div>
  </div>

  <div id="adminUsersSection" class="section" style="display: none;">
    <h2>Gestión de Usuarios</h2>
    <table>
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Correo</th>
          <th>Departamento</th>
          <th>Rol</th>
          <th>Jefe</th>
          <th>Días Vacaciones</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="usersTableBody"></tbody>
    </table>
  </div>

  <!-- Todos los Tickets (solo admin) -->
  <div id="adminTicketsSection" class="section" style="display: none;">
    <h2>Todos los Tickets</h2>
    <button onclick="backToMenu()">Volver al Menú</button>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Solicitante</th><th>Departamento</th><th>Fecha</th><th>Prioridad</th><th>Categoría</th><th>Estado</th><th>Asignado a</th>
        </tr>
      </thead>
      <tbody id="adminTicketList"></tbody>
    </table>
  </div>

  <!-- Todos los Permisos (solo admin) -->
  <div id="adminPermisosSection" class="section" style="display: none;">
    <h2>Todos los Permisos</h2>
    <button onclick="backToMenu()">Volver al Menú</button>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Empleado</th><th>Tipo</th><th>Motivo</th><th>Fechas</th><th>Estado</th><th>Fecha Solicitud</th>
        </tr>
      </thead>
      <tbody id="adminPermisoList"></tbody>
    </table>
  </div>

  <script>
    let usuarioEditandoId = null;

    function formatearFecha(fecha) {
      if (!fecha) return '';
      const d = new Date(fecha);
      return d.toLocaleString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    function showForgotPassword() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('forgotPasswordSection').style.display = 'block';
      document.getElementById('forgotPasswordError').textContent = '';
      document.getElementById('forgotPasswordSuccess').textContent = '';
      document.getElementById('forgotEmail').value = '';
    }
    function hideForgotPassword() {
      document.getElementById('forgotPasswordSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    }
    async function forgotPassword() {
      const email = document.getElementById('forgotEmail').value;
      const error = document.getElementById('forgotPasswordError');
      const success = document.getElementById('forgotPasswordSuccess');
      error.textContent = '';
      success.textContent = '';
      if (!email || !email.includes('@')) {
        error.textContent = 'Por favor, ingresa un correo electrónico válido';
        return;
      }
      try {
        const response = await fetch('/api/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await response.json();
        if (data.error) {
          error.textContent = data.error;
        } else {
          success.textContent = 'Se ha enviado un correo con tu nueva contraseña.';
        }
      } catch (err) {
        error.textContent = 'Error en el servidor';
      }
    }

    async function login() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const error = document.getElementById('loginError');

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await response.json();
        if (data.error) {
          error.textContent = data.error;
          return;
        }
        currentUser = data;
        localStorage.setItem('user', JSON.stringify(currentUser));
        mostrarMenuPrincipal();
      } catch (err) {
        error.textContent = 'Error en el servidor';
      }
    }

    // Si ya hay usuario logueado, muestra el menú principal directamente
    window.onload = function() {
      const user = localStorage.getItem('user');
      if (user) {
        currentUser = JSON.parse(user);
        mostrarMenuPrincipal();
      }
    }

    function logout() {
      localStorage.removeItem('user');
      currentUser = null;
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
    }


    async function fillJefesSelect() {
      const adminId = currentUser.id;
      const res = await fetch(`/api/users?adminId=${adminId}`);
      const users = await res.json();
      const select = document.getElementById('registerJefe');
      select.innerHTML = '<option value="">Sin jefe</option>';
      if (Array.isArray(users)) {
        users.forEach(u => {
          select.innerHTML += `<option value="${u.id}">${u.username} (${u.department})</option>`;
        });
      } else {
        select.innerHTML += `<option value="">Error al cargar usuarios</option>`;
        console.error(users);
      }
    }

    function showAdminTickets() {
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('adminTicketsSection').style.display = 'block';
      cargarTodosTickets();
    }
    function showAdminPermisos() {
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('adminPermisosSection').style.display = 'block';
      cargarTodosPermisos();
    }

    function showAdminSection() {
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('formSection').style.display = 'block';
      document.getElementById('adminUsersSection').style.display = 'block';
      fillJefesSelect();
      cargarUsuarios();
    }

    function backToMenu() {
      document.getElementById('adminTicketsSection').style.display = 'none';
      document.getElementById('adminPermisosSection').style.display = 'none';
      document.getElementById('formSection').style.display = 'none';
      document.getElementById('adminUsersSection').style.display = 'none';
      document.getElementById('mainMenu').style.display = 'block';
    }

    // Al mostrar el menú principal, muestra los botones de admin si corresponde
    function mostrarMenuPrincipal() {
      document.getElementById('menuUser').textContent = currentUser.username;
      document.getElementById('menuDepartment').textContent = currentUser.department;
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('mainMenu').style.display = 'block';
      if (currentUser.role === 'admin') {
        document.getElementById('btnAdminUsers').style.display = 'inline-block';
        document.getElementById('btnAdminTickets').style.display = 'inline-block';
        document.getElementById('btnAdminPermisos').style.display = 'inline-block';
      }
      // Mostrar botón de checador solo para RH
      if (currentUser.department === 'Sistemas') {
        document.getElementById('btnInventario').style.display = 'inline-block';
      } else {
        document.getElementById('btnInventario').style.display = 'none';
      }
      // Mostrar botón de checador solo para RH
      if (currentUser.role === 'RH') {
        document.getElementById('btnRHChecador').style.display = 'inline-block';
      } else {
        document.getElementById('btnRHChecador').style.display = 'none';
      }
    }

    async function cargarUsuarios() {
      const adminId = currentUser.id;
      const res = await fetch(`/api/users?adminId=${adminId}`);
      const users = await res.json();
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';
      if (Array.isArray(users)) {
        users.forEach(u => {
          tbody.innerHTML += `
            <tr>
              <td>${u.username}</td>
              <td>${u.email}</td>
              <td>${u.department}</td>
              <td>${u.role}</td>
              <td>${u.jefe_nombre || ''}</td>
              <td>${u.dias_vacaciones || 0}</td>
              <td>
                <button onclick="editarUsuario('${u.id}')">Editar</button>
                <button onclick="eliminarUsuario('${u.id}')">Eliminar</button>
              </td>
            </tr>
          `;
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="7">No autorizado o error en la petición</td></tr>`;
        console.error(users);
      }
    }

    async function eliminarUsuario(id) {
      if (!confirm('¿Seguro que deseas eliminar este usuario?')) return;
      const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
      const data = await res.json();
      if (data.success) {
        alert('Usuario eliminado correctamente');
        cargarUsuarios();
      } else {
        alert('Error al eliminar usuario');
      }
    }

   async function editarUsuario(id) {
     const adminId = currentUser.id;
     const res = await fetch(`/api/users/${id}?adminId=${adminId}`);
     const user = await res.json();
     usuarioEditandoId = id;
     document.getElementById('registerUsername').value = user.username;
     document.getElementById('registerPassword').value = '';
     document.getElementById('registerEmail').value = user.email;
     document.getElementById('registerDepartment').value = user.department;
     document.getElementById('registerRole').value = user.role;
     document.getElementById('registerJefe').value = user.jefe_inmediato_id || '';
     document.getElementById('registerVacaciones').value = user.dias_vacaciones || 0;
     document.getElementById('formSection').style.display = 'block';
     document.querySelector('#formSection button[onclick="register()"]').textContent = 'Actualizar Usuario';
   }

    async function register() {
      const username = document.getElementById('registerUsername').value;
      const password = document.getElementById('registerPassword').value;
      const email = document.getElementById('registerEmail').value;
      const department = document.getElementById('registerDepartment').value;
      const role = document.getElementById('registerRole').value;
      const jefe = document.getElementById('registerJefe').value;
      const vacaciones = document.getElementById('registerVacaciones').value;
      const error = document.getElementById('registerError');
      error.textContent = '';

      // Validaciones básicas
      if (!username || !email || !department || !role) {
        error.textContent = 'Completa todos los campos obligatorios';
        return;
      }

      let url = '/api/users';
      let method = 'POST';
      let body = {
        username,
        password,
        email,
        department,
        role,
        jefe_inmediato_id: jefe,
        dias_vacaciones: vacaciones,
        adminId: currentUser.id // importante para autorización
      };

      if (usuarioEditandoId) {
        url = `/api/users/${usuarioEditandoId}`;
        method = 'PUT';
        if (!password) delete body.password; // No actualizar si está vacío
      }

      try {
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.error) {
          error.textContent = data.error;
        } else {
          alert(usuarioEditandoId ? 'Usuario actualizado' : 'Usuario creado');
          usuarioEditandoId = null;
          cargarUsuarios();
          // Limpia el formulario si quieres
          document.getElementById('registerUsername').value = '';
          document.getElementById('registerPassword').value = '';
          document.getElementById('registerEmail').value = '';
          document.getElementById('registerDepartment').value = '';
          document.getElementById('registerRole').value = '';
          document.getElementById('registerJefe').value = '';
          document.getElementById('registerVacaciones').value = 0;
          error.textContent = '';
          // Devuelve el texto del botón a "Crear Usuario"
          document.querySelector('#formSection button[onclick="register()"]').textContent = 'Crear Usuario';
        }
      } catch (err) {
        error.textContent = 'Error en el servidor';
      }
    }

    async function cargarTodosTickets() {
      const userId = currentUser.id;
      const res = await fetch(`/api/tickets?all=1&userId=${userId}`);
      const tickets = await res.json();
      const tbody = document.getElementById('adminTicketList');
      tbody.innerHTML = '';
      if (Array.isArray(tickets)) {
        tickets.forEach(t => {
          tbody.innerHTML += `<tr>
            <td>${t.id}</td>
            <td>${t.requester}</td>
            <td>${t.department}</td>
            <td>${t.created_at}</td>
            <td>${t.priority}</td>
            <td>${t.category}</td>
            <td>${t.status}</td>
            <td>${t.assigned_username || 'No asignado'}</td>
          </tr>`;
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="8">No autorizado o error en la petición</td></tr>`;
        console.error(tickets);
      }
    }

    async function cargarTodosPermisos() {
      const userId = currentUser.id;
      const res = await fetch(`/api/permisos?all=1&user_id=${userId}`);
      const permisos = await res.json();
      const tbody = document.getElementById('adminPermisoList');
      tbody.innerHTML = '';
      if (Array.isArray(permisos)) {
        permisos.forEach(p => {
          tbody.innerHTML += `<tr>
            <td>${p.id}</td>
            <td>${p.username}</td>
            <td>${p.tipo}</td>
            <td>${p.motivo}</td>
            <td>${formatearFecha(p.fecha_inicio)}${p.fecha_fin ? ' - ' + formatearFecha(p.fecha_fin) : ''}</td>
            <td>${p.estado}</td>
            <td>${p.fecha_solicitud_ajustada || ''}</td>
          </tr>`;
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="7">No autorizado o error en la petición</td></tr>`;
        console.error(permisos);
      }
    }

  </script>
</body>
</html>