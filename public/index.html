<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gestión</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <!-- Pantalla de Login -->
    <div id="loginSection" class="section">
      <h1>Sistema de Gestión</h1>
      <h2>Iniciar Sesión</h2>
      <div class="form-group">
        <label for="loginUsername">Usuario</label>
        <input type="text" id="loginUsername" placeholder="Nombre de usuario" required>
      </div>
      <div class="form-group">
        <label for="loginPassword">Contraseña</label>
        <input type="password" id="loginPassword" placeholder="Contraseña" required>
      </div>
      <button onclick="login()">Iniciar Sesión</button>
      <p class="error" id="loginError"></p>
      <a class="link" onclick="showForgotPassword()">¿Olvidaste tu contraseña?</a>
    </div>

    <!-- Modal Olvidé mi contraseña -->
    <div id="forgotPasswordSection" class="section" style="display: none;">
      <h2>Recuperar Contraseña</h2>
      <div class="form-group">
        <label for="forgotEmail">Correo Electrónico</label>
        <input type="email" id="forgotEmail" placeholder="correo@ejemplo.com" required>
      </div>
      <button onclick="forgotPassword()">Enviar</button>
      <button class="back" onclick="hideForgotPassword()">Volver</button>
      <p class="error" id="forgotPasswordError"></p>
      <p class="success" id="forgotPasswordSuccess"></p>
    </div>

    <!-- Menú Principal -->
    <div id="mainMenu" class="section" style="display: none;">
      <h1>Menú Principal</h1>
      <p>Bienvenido, <span id="menuUser"></span> (<span id="menuDepartment"></span>)</p>
      <button class="logout" onclick="logout()">Cerrar Sesión</button>
      <div class="menu-buttons">
        <button onclick="window.location.href='tickets.html'">Tickets</button>
        <button onclick="window.location.href='permiso.html'">Permisos</button>
        <button onclick="window.location.href='inventario.html'">Inventario</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;

    function showForgotPassword() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('forgotPasswordSection').style.display = 'block';
      document.getElementById('forgotPasswordError').textContent = '';
      document.getElementById('forgotPasswordSuccess').textContent = '';
      document.getElementById('forgotEmail').value = '';
    }
    function hideForgotPassword() {
      document.getElementById('forgotPasswordSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    }
    async function forgotPassword() {
      const email = document.getElementById('forgotEmail').value;
      const error = document.getElementById('forgotPasswordError');
      const success = document.getElementById('forgotPasswordSuccess');
      error.textContent = '';
      success.textContent = '';
      if (!email || !email.includes('@')) {
        error.textContent = 'Por favor, ingresa un correo electrónico válido';
        return;
      }
      try {
        const response = await fetch('/api/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await response.json();
        if (data.error) {
          error.textContent = data.error;
        } else {
          success.textContent = 'Se ha enviado un correo con tu nueva contraseña.';
        }
      } catch (err) {
        error.textContent = 'Error en el servidor';
      }
    }

    async function login() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const error = document.getElementById('loginError');

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await response.json();
        if (data.error) {
          error.textContent = data.error;
          return;
        }
        currentUser = data;
        localStorage.setItem('user', JSON.stringify(currentUser));
        document.getElementById('menuUser').textContent = data.username;
        document.getElementById('menuDepartment').textContent = data.department;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'block';
      } catch (err) {
        error.textContent = 'Error en el servidor';
      }
    }

    function logout() {
      localStorage.removeItem('user');
      currentUser = null;
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
    }

    // Si ya hay usuario logueado, muestra el menú principal directamente
    window.onload = function() {
      const user = localStorage.getItem('user');
      if (user) {
        currentUser = JSON.parse(user);
        document.getElementById('menuUser').textContent = currentUser.username;
        document.getElementById('menuDepartment').textContent = currentUser.department;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'block';
      }
    }
  </script>
</body>
</html>